## Deadlock

Deadlock은 교착 상태를 의미하는데, 교착 상태란 프로세스가 자원을 얻지 못해 다음 처리를 진행하지 못하는 상태를 말한다.

### Deadlock 발생 조건

네 가지 조건을 모두 만족하면 Deadlock이 발생한다. 따라서 아래의 4가지 조건중 하나라도 성립하지 않도록 만든다면 교착상태를 해결할 수 있다.

1. **상호 배제(Mutual exclusion)** : 하나의 공유 자원에 대해 두 개 이상의 프로세스가 동시에 접근할 수 없다.

2. **점유와 대기(Hold and wait)** : 하나의 자원을 점유하고 있는 프로세스가 있고, 해당 프로세스가 다른 프로세스에서 자원을 얻기 위해서는 요청을 하고 대기해야 한다.

3. **비선점(No preemption)** : 특정 프로세스가 어떤 자원을 사용하고 있을 때 그 해당 자원 사용이 끝나기 전까지는 그 자원을 뺏을 수 없다.

4. **순환 대기(Circular wait)** : 프로세스들이 서로 사용하고 있는 자원에 대해서 순환적으로 대기한다.

### Deadlock 해결 방법

- 교착 상태 예방 : 교착 상태가 발생되지 않도록 사전에 예방하는 것으로, Deadlock 발생 조건 중 하나를 제거함으로써 해결하는 방법이다. 일반적으로 자원 사용 효율성이 떨어지고 비용이 많이 드는 방법이다.

먼저 상호배제 조건을 제거함으로써 하나의 공유자원에 대해 프로세스들이 동시에 접근할 수 있다. 그 다음으로 특정 프로세스가 어떤 작업을 수행할 때 그 작업에 필요한 리소스를 먼저 요청하고 할당받은 다음에 작업을 수행함으로써 점유와 대기 조건을 제거 할 수 있다. 프로세스들이 어떤 리소스들을 필요로 하는지 파악하는데 추가적인 오버헤드가 발생할 수 있다. 또한 비선점 조건을 제거하기 위해 프로세스가 다른 프로세스의 자원을 요청하기 위해서는 자신이 할당 받았던 자원을 반납한다. 단점은 현재까지 작업했던 프로세스의 상태를 잃을 수 있다. 마지막으로 각각의 자원들에 대해 고유번호를 할당 하고 특정 프로세스 내 자신이 할당받은 자원에 번호를 기준으로 오름차순 혹은 내림차순으로만 요청을 할 수 있도록 하여 순환 대기 조건을 제거할 수 있다.

- 교착 상태 회피 : 교착 상태 발생 가능성을 검사해서 발생 가능성이 있다면 사전에 회피하는 방식이다. 자원을 요청할 때마다 시스템 검사를 하는 만큼 오버헤드가 크다. 자원 할당 그래프 알고리즘과 은행원 알고리즘이 있다.

  - 프로세스가 자원 요청 시, 자원을 할당한 후에도 안정 상태로 남아 있는지 사전 검사
  - 안정 상태라면 자원을 할당
  - 불안정 상태라면 다른 프로세스가 자원을 해지할 때 까지 대기

- 교착 상태 탐지 및 회복 : 교착 상태를 허용하지만 상태를 탐지하고 회복하는 방식이다. 알고리즘을 주기적으로 실행함으로써 시스템에 발생한 Deadlock을 체크하고 회복한다. 교착상태로부터 회복이란 교착상태를 일으킨 프로세스를 종료하거나, 할당된 자원을 해제함으로써 회복하는 거을 의미한다.

  - 프로세스 종료 방식 : 교착 상태의 프로세스를 모두 중지하거나 교착 상태가 제거될 때까지 한 프로세스씩 중지한다.
  - 자원 선점 방식 : 교착 상태가 제거될 때까지 프로세스가 점유한 자원을 선점해 다른 프로세스에게 할당한다.

회복 고려 사항에는 세 가지가 있다.

1. 희생자 선택 : Deadlock에서 회복 할 때 어떤 프로세스를 죽일 것인지 혹은 어떤 프로세스의 자원을 선점하여 다른 프로세스에게 할당할 것인지 선택한다.

2. 후퇴(Rollback) : 희생자를 선택 하였다면 해당 프로세스를 어느 정도 수준으로 롤백을 시킬 것인지 예를 들어 프로세스를 아예 죽였다가 새로 킬 것인지 재시작을 할 것인지, 아니면 교착 상태가 어느 정도 해결이 될 만큼만 롤백을 시킬 것인지 등을 고려한다.

3. 기아 상태(Starvation)

- 교착 상태 무시 : 교착 상태 자체를 무시하고 특별한 조치를 취하지 않는 방법이다. 교착 상태의 발생 확률이 낮은 운영체제에서 주로 사용한다. 교착 상태를 주기적으로 탐지함으로써 얻는 성능저하, 오버헤드보다 차라리 무시하는 것이 나을 경우 사용한다.

<br>

참고

[우아한Tech Deadlock](https://www.youtube.com/watch?v=Ry_gB34cvwc)
